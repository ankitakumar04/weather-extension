var components=function(){var t=function(t,e,n){var a=document.createElement(t);for(var r in e)a.setAttribute(r,e[r]);return a.innerHTML=n||null,a},e=function(e){this.attrs=e,this.render=function(){var e=t("div",{"class":"current"}),n=t("img",{"class":"current-img",src:this.attrs.img,alt:"icon"}),a=t("div",{"class":"weather"});return a.appendChild(t("span",{},this.attrs.temp+"&deg")),a.appendChild(t("span",{},this.attrs.desc)),e.appendChild(n),e.appendChild(a),e}},n=function(e){this.attrs=e,this.render=function(){var e=t("div",{"class":"period"});return e.appendChild(t("span",{"class":"time"},this.attrs.time)),e.appendChild(t("img",{src:this.attrs.img,alt:"icon"})),e.appendChild(t("span",{"class":"temp"},this.attrs.temp+"&deg")),e.appendChild(t("span",{"class":"precip"},this.attrs.precip+this.attrs.length_unit)),e}},a=function(e){this.attrs=e,this.render=function(){for(var e=t("div",{"class":"today"}),a=new n,r=this.attrs.today.length,s=0;r>s;s++)a.attrs=this.attrs.today[s],e.appendChild(a.render());return e}},r=function(e){this.attrs=e,this.render=function(){var e=t("div",{"class":"weather"},'<span class="temp">'+this.attrs.temp+'&deg</span><span class="description">'+this.attrs.desc+"</span>"),n=t("div",{"class":"date"},'<p class="weekday">'+this.attrs.weekday+'</p><p class="month">'+this.attrs.month+"</p>"),a=t("div",{"class":"img-wrapper"});a.appendChild(t("img",{src:this.attrs.img,alt:"icon"}));var r=t("div",{"class":"day"});return r.appendChild(a),r.appendChild(e),r.appendChild(n),r}},s=function(e){this.attrs=e,this.render=function(){for(var e=t("div",{"class":"forecast"}),n=new r,a=this.attrs.days.length,s=0;a>s;s++)n.attrs=this.attrs.days[s],e.appendChild(n.render());return e}},i=function(e){this.attrs=e,this.render=function(){var e=t("span",{"data-id":this.attrs.id},this.attrs.name),n=t("span",{},this.attrs.temp+"&deg;"),a=t("div",{"class":"location"});return a.appendChild(e),a.appendChild(n),a}},o=function(e){this.atts=e,this.render=function(){return t("div",{id:"location-spinner","class":"spinner",style:"display: block;"},"<div></div><div></div><div></div>")}};return{Current:e,Period:n,Today:a,Day:r,Forecast:s,Location:i,LocationSpinner:o}}(),helpers=function(){var t=function(t,e,n,a){var r=new XMLHttpRequest;r.open(e,t,!0),r.onload=function(){this.status>=200&&this.status<400?n(this):a(this)},r.onerror=function(){a(this)},r.send()},e=function(t){for(var e=t.length,n=0;e>n;n++)if(!t[n])return!1;return!0},n=function(t){var e=18e5;return Date.now()-t>e},a=function(t,e){return t-=273.15,"imperial"==e&&(t=1.8*t+32),Math.round(t)},r=function(t,e){return"imperial"==e&&(t=.03937*t),t};return{ajax:t,arrayAllTrue:e,cacheExpired:n,convertTemp:a,convertLength:r}}(),main=function(){var t=function(t,e,n){var a=new components.Current(t),r=new components.Today({today:e}),s=new components.Forecast({days:n}),i=document.getElementById("main");i.innerHTML="",i.appendChild(a.render()),i.appendChild(document.createElement("hr")),i.appendChild(r.render()),i.appendChild(document.createElement("hr")),i.appendChild(s.render())},e=function(e){chrome.storage.sync.get("units",function(n){var a=n.units||"metric";console.log(e);var r,s,i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],o=["January","February","March","April","May","June","July","August","September","October","November","December"],c={img:"icons/"+e[0].weather[0].icon.substr(0,2)+".png",temp:helpers.convertTemp(e[0].main.temp,a),desc:e[0].weather[0].main},l=[];for(r=0;5>r;r++){s=new Date(1e3*e[1].list[r].dt);var d="0"+s.getHours();d=d.substr(d.length-2);var p="0"+s.getMinutes();p=p.substr(p.length-2);var u=0;e[1].list[r].rain?u=+e[1].list[r].rain["3h"]:e[1].list[r].snow&&(u=+e[1].list[r].snow["3h"]),u=helpers.convertLength(u,a).toFixed(2),length_unit="imperial"==a?"in":"mm",l.push({img:"icons/"+e[1].list[r].weather[0].icon.substr(0,2)+".png",temp:helpers.convertTemp(e[1].list[r].main.temp,a),precip:u,length_unit:length_unit,time:d+":"+p})}var h=[];for(r=0;5>r;r++)s=new Date(1e3*e[2].list[r].dt),h.push({img:"icons/"+e[2].list[r].weather[0].icon.substr(0,2)+".png",temp:helpers.convertTemp(e[2].list[r].temp.max,a),desc:e[2].list[r].weather[0].main,weekday:i[s.getDay()],month:o[s.getMonth()]+" "+s.getDate()});t(c,l,h)})},n=function(t,n,a,r){chrome.storage.local.get(t,function(s){if(s[t]&&!helpers.cacheExpired(JSON.parse(s[t]).setAt))console.log("cache"),a[r]=JSON.parse(s[t]),helpers.arrayAllTrue(a)&&e(a);else{var i=document.getElementById("spinner");i.style.display="block",helpers.ajax(n,"GET",function(n){console.log("ajaxed");var s=JSON.parse(n.response);a[r]=s;var o={};s.setAt=Date.now(),o[t]=JSON.stringify(s),chrome.storage.local.set(o),helpers.arrayAllTrue(a)&&(e(a),i.style.display="none")},function(){console.log("error")})}})},a=function(){chrome.storage.sync.get("loc",function(t){t=t.loc&&JSON.parse(t.loc);var e={id:t&&t.id||6176823,name:t&&t.name||"waterloo"},a=[null,null,null];n("currentWeatherData","http://api.openweathermap.org/data/2.5/weather?id="+e.id,a,0),n("todayWeatherData","http://api.openweathermap.org/data/2.5/forecast?id="+e.id,a,1),n("forecastWeatherData","http://api.openweathermap.org/data/2.5/forecast/daily?id="+e.id,a,2),document.getElementById("location").innerText=e.name.substr(0,1).toUpperCase()+e.name.substr(1)}),chrome.storage.sync.get("units",function(t){for(var e=t.units||"metric",n=document.getElementsByClassName("units-btn"),a=n.length,r=0;a>r;r++)n[r].dataset.units==e?n[r].setAttribute("class","units-btn active"):n[r].setAttribute("class","units-btn")})};return{init:a}}(),interactions=function(){var t=function(){var t=document.getElementById("sidebar");t.style.display="block"===t.style.display?"none":"block"},e=function(){chrome.storage.local.clear(),main.init()},n=function(t,n,a){chrome.storage.sync.set({units:t.target.dataset.units});for(var r=a.length,s=0;r>s;s++)a[s].setAttribute("class","units-btn");a[n].setAttribute("class","units-btn active"),e()},a=function(n){var a=n.target.dataset.id;chrome.storage.local.get("locNames",function(n){if(n&&n.locNames){var r=JSON.parse(n.locNames)[a];chrome.storage.sync.set({loc:JSON.stringify({name:r,id:a})},function(){e(),t();var n=document.getElementById("locations");n.innerHTML="",document.getElementById("location-input").value="",chrome.storage.local.remove("locNames")})}})},r=function(){var t=document.getElementById("locations");t.innerHTML="",t.appendChild((new components.LocationSpinner).render());var e=document.getElementById("location-input").value;helpers.ajax("http://api.openweathermap.org/data/2.5/find?&q="+e+"&type=like&sort=population","GET",function(e){chrome.storage.sync.get("units",function(n){var r=n.units||"metric",s=JSON.parse(e.response),i={};t.innerHTML="";var o=new components.Location;s.list.map(function(e){var n=e.name+","+e.sys.country,s=e.id,c=helpers.convertTemp(e.main.temp,r);o.attrs={name:n,id:s,temp:c};var l=o.render();l.onclick=a,t.appendChild(l),i[e.id]=e.name}),chrome.storage.local.set({locNames:JSON.stringify(i)})})},function(){console.log("error")})};document.getElementById("menu-icon").onclick=t,document.getElementById("refresh").onclick=e,document.getElementById("search").onclick=r,document.getElementById("location-input").onkeypress=function(t){13==t.keyCode&&r(t)};var s=document.getElementsByClassName("units-btn");Array.prototype.forEach.call(s,function(t,e,a){t.onclick=function(t){n(t,e,a)}})}();main.init();