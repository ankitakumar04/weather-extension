var components=function(){var e=function(e,t,n){var a=document.createElement(e);for(var r in t)a.setAttribute(r,t[r]);return a.innerHTML=n||null,a},t=function(t){this.attrs=t,this.render=function(){var t=e("div",{"class":"current"}),n=e("img",{"class":"current-img",src:this.attrs.img,alt:"icon"}),a=e("div",{"class":"weather"});return a.appendChild(e("span",{},this.attrs.temp+"&deg")),a.appendChild(e("span",{},this.attrs.desc)),t.appendChild(n),t.appendChild(a),t}},n=function(t){this.attrs=t,this.render=function(){var t=e("div",{"class":"period"});return t.appendChild(e("span",{"class":"time"},this.attrs.time)),t.appendChild(e("img",{src:this.attrs.img,alt:"icon"})),t.appendChild(e("span",{"class":"temp"},this.attrs.temp+"&deg")),t.appendChild(e("span",{"class":"precip"},this.attrs.precip+this.attrs.length_unit)),t}},a=function(t){this.attrs=t,this.render=function(){for(var t=e("div",{"class":"today"}),a=new n,r=this.attrs.today.length,s=0;r>s;s++)a.attrs=this.attrs.today[s],t.appendChild(a.render());return t}},r=function(t){this.attrs=t,this.render=function(){var t=e("div",{"class":"weather"},'<span class="temp">'+this.attrs.temp+'&deg</span><span class="description">'+this.attrs.desc+"</span>"),n=e("div",{"class":"date"},'<p class="weekday">'+this.attrs.weekday+'</p><p class="month">'+this.attrs.month+"</p>"),a=e("div",{"class":"img-wrapper"});a.appendChild(e("img",{src:this.attrs.img,alt:"icon"}));var r=e("div",{"class":"day"});return r.appendChild(a),r.appendChild(t),r.appendChild(n),r}},s=function(t){this.attrs=t,this.render=function(){for(var t=e("div",{"class":"forecast"}),n=new r,a=this.attrs.days.length,s=0;a>s;s++)n.attrs=this.attrs.days[s],t.appendChild(n.render());return t}},i=function(t){this.attrs=t,this.render=function(){var t=e("span",{"data-id":this.attrs.id},this.attrs.name),n=e("span",{},this.attrs.temp+"&deg;"),a=e("div",{"class":"location"});return a.appendChild(t),a.appendChild(n),a}},o=function(t){this.atts=t,this.render=function(){return e("div",{id:"location-spinner","class":"spinner",style:"display: block;"},"<div></div><div></div><div></div>")}};return{Current:t,Period:n,Today:a,Day:r,Forecast:s,Location:i,LocationSpinner:o}}(),helpers=function(){var e=function(e,t,n,a){var r=new XMLHttpRequest;r.open(t,e,!0),r.onload=function(){this.status>=200&&this.status<400?n(this):a(this)},r.onerror=function(){a(this)},r.send()},t=function(e){for(var t=e.length,n=0;t>n;n++)if(!e[n])return!1;return!0},n=function(e){var t=18e5;return Date.now()-e>t},a=function(e,t){return e-=273.15,"imperial"==t&&(e=1.8*e+32),Math.round(e)},r=function(e,t){return"imperial"==t&&(e=.03937*e),e};return{ajax:e,arrayAllTrue:t,cacheExpired:n,convertTemp:a,convertLength:r}}(),main=function(){var e=function(e){var t=new components.Current(e.current),n=new components.Today({today:e.today}),a=new components.Forecast({days:e.forecast}),r=document.getElementById("main");r.innerHTML="",r.appendChild(t.render()),r.appendChild(document.createElement("hr")),r.appendChild(n.render()),r.appendChild(document.createElement("hr")),r.appendChild(a.render())},t=function(e,t){chrome.storage.sync.get("units",function(n){var a=n.units||"metric";console.log(e);var r,s,i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],o=["January","February","March","April","May","June","July","August","September","October","November","December"],c={img:"icons/"+e[0].weather[0].icon.substr(0,2)+".png",temp:helpers.convertTemp(e[0].main.temp,a),desc:e[0].weather[0].main},l=[];for(r=0;5>r;r++){s=new Date(1e3*e[1].list[r].dt);var d="0"+s.getHours();d=d.substr(d.length-2);var p="0"+s.getMinutes();p=p.substr(p.length-2);var u=0;e[1].list[r].rain?u=+e[1].list[r].rain["3h"]:e[1].list[r].snow&&(u=+e[1].list[r].snow["3h"]),u=helpers.convertLength(u,a).toFixed(2),length_unit="imperial"==a?"in":"mm",l.push({img:"icons/"+e[1].list[r].weather[0].icon.substr(0,2)+".png",temp:helpers.convertTemp(e[1].list[r].main.temp,a),precip:u,length_unit:length_unit,time:d+":"+p})}var m=[];for(r=0;5>r;r++)s=new Date(1e3*e[2].list[r].dt),m.push({img:"icons/"+e[2].list[r].weather[0].icon.substr(0,2)+".png",temp:helpers.convertTemp(e[2].list[r].temp.max,a),desc:e[2].list[r].weather[0].main,weekday:i[s.getDay()],month:o[s.getMonth()]+" "+s.getDate()});t({current:c,today:l,forecast:m})})},n=function(e,t,n,a,r){chrome.storage.local.get(e,function(s){if(s[e]&&!helpers.cacheExpired(JSON.parse(s[e]).setAt))console.log("cache"),n[a]=JSON.parse(s[e]),helpers.arrayAllTrue(n)&&r(n);else{var i=document.getElementById("spinner");i.style.display="block",helpers.ajax(t,"GET",function(t){console.log("ajaxed");var s=JSON.parse(t.response);n[a]=s;var o={};s.setAt=Date.now(),o[e]=JSON.stringify(s),chrome.storage.local.set(o),helpers.arrayAllTrue(n)&&(r(n),i.style.display="none",document.getElementById("error-message").style.display="none")},function(){console.log("error"),i.style.display="none",document.getElementById("error-message").style.display="block"})}})},a=function(){chrome.storage.sync.get("loc",function(a){if(a=a.loc&&JSON.parse(a.loc),!(a&&a.id&&a.name))return document.getElementById("sidebar").style.display="block",void(document.getElementById("no-location").style.display="block");var r={id:a.id,name:a.name},s=[null,null,null],i=function(n){t(n,e)};n("currentWeatherData","http://api.openweathermap.org/data/2.5/weather?id="+r.id+"&APPID=1ef0ce4e8b21c0a827f07386ab22a757",s,0,i),n("todayWeatherData","http://api.openweathermap.org/data/2.5/forecast?id="+r.id+"&APPID=1ef0ce4e8b21c0a827f07386ab22a757",s,1,i),n("forecastWeatherData","http://api.openweathermap.org/data/2.5/forecast/daily?id="+r.id+"&APPID=1ef0ce4e8b21c0a827f07386ab22a757",s,2,i),document.getElementById("location").innerText=r.name.substr(0,1).toUpperCase()+r.name.substr(1)}),chrome.storage.sync.get("units",function(e){for(var t=e.units||"metric",n=document.getElementsByClassName("units-btn"),a=n.length,r=0;a>r;r++)n[r].dataset.units==t?n[r].setAttribute("class","units-btn active"):n[r].setAttribute("class","units-btn")})};return{init:a}}(),interactions=function(){var e=function(){var e=document.getElementById("sidebar");e.style.display="block"===e.style.display?"none":"block"},t=function(){chrome.storage.local.clear(),main.init()},n=function(e,n,a){chrome.storage.sync.set({units:e.target.dataset.units});for(var r=a.length,s=0;r>s;s++)a[s].setAttribute("class","units-btn");a[n].setAttribute("class","units-btn active"),t()},a=function(n){var a=n.target.dataset.id;chrome.storage.local.get("locNames",function(n){if(n&&n.locNames){var r=JSON.parse(n.locNames)[a];chrome.storage.sync.set({loc:JSON.stringify({name:r,id:a})},function(){t(),e();var n=document.getElementById("locations");n.innerHTML="",document.getElementById("location-input").value="",chrome.storage.local.remove("locNames")})}})},r=function(){var e=document.getElementById("locations");e.innerHTML="",e.appendChild((new components.LocationSpinner).render());var t=document.getElementById("location-input").value;helpers.ajax("http://api.openweathermap.org/data/2.5/find?&q="+t+"&type=like&sort=population","GET",function(t){chrome.storage.sync.get("units",function(n){var r=n.units||"metric",s=JSON.parse(t.response),i={};e.innerHTML="";var o=new components.Location;s.list.map(function(t){var n=t.name+","+t.sys.country,s=t.id,c=helpers.convertTemp(t.main.temp,r);o.attrs={name:n,id:s,temp:c};var l=o.render();l.onclick=a,e.appendChild(l),i[t.id]=t.name}),chrome.storage.local.set({locNames:JSON.stringify(i)})})},function(){console.log("error"),e.innerHTML="";var t=document.createElement("p");t.setAttribute("id","locations-error"),t.innerText="Unable to search for locations.",e.appendChild(t)})};document.getElementById("menu-icon").onclick=e,document.getElementById("refresh").onclick=t,document.getElementById("search").onclick=r,document.getElementById("location-input").onkeypress=function(e){13==e.keyCode&&r(e)};var s=document.getElementsByClassName("units-btn");Array.prototype.forEach.call(s,function(e,t,a){e.onclick=function(e){n(e,t,a)}})}();main.init();