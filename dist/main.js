var components=function(){var t=function(t,e,n){var a=document.createElement(t);for(var s in e)a.setAttribute(s,e[s]);return a.innerHTML=n||null,a},e=function(e){this.attrs=e,this.render=function(){var e=t("div",{"class":"current"}),n=t("img",{"class":"current-img",src:this.attrs.img,alt:"icon"}),a=t("div",{"class":"weather"});return a.appendChild(t("span",{},this.attrs.temp+"&deg")),a.appendChild(t("span",{},this.attrs.desc)),e.appendChild(n),e.appendChild(a),e}},n=function(e){this.attrs=e,this.render=function(){var e=t("div",{"class":"period"});return e.appendChild(t("span",{"class":"time"},this.attrs.time)),e.appendChild(t("img",{src:this.attrs.img,alt:"icon"})),e.appendChild(t("span",{"class":"temp"},this.attrs.temp+"&deg")),e.appendChild(t("span",{"class":"precip"},this.attrs.precip+this.attrs.length_unit)),e}},a=function(e){this.attrs=e,this.render=function(){for(var e=t("div",{"class":"today"}),a=new n,s=this.attrs.today.length,i=0;s>i;i++)a.attrs=this.attrs.today[i],e.appendChild(a.render());return e}},s=function(e){this.attrs=e,this.render=function(){var e=t("div",{"class":"weather"},'<span class="temp">'+this.attrs.temp+'&deg</span><span class="description">'+this.attrs.desc+"</span>"),n=t("div",{"class":"date"},'<p class="weekday">'+this.attrs.weekday+'</p><p class="month">'+this.attrs.month+"</p>"),a=t("div",{"class":"img-wrapper"});a.appendChild(t("img",{src:this.attrs.img,alt:"icon"}));var s=t("div",{"class":"day"});return s.appendChild(a),s.appendChild(e),s.appendChild(n),s}},i=function(e){this.attrs=e,this.render=function(){for(var e=t("div",{"class":"forecast"}),n=new s,a=this.attrs.days.length,i=0;a>i;i++)n.attrs=this.attrs.days[i],e.appendChild(n.render());return e}},r=function(e){this.attrs=e,this.render=function(){var e=this.attrs.name.split(",")[0].trim().replace(/\s/g,"").toLowerCase(),n=t("span",{"data-name":e,"data-id":this.attrs.id},this.attrs.name),a=t("span",{},this.attrs.temp+"&deg;"),s=t("div",{"class":"location"});return s.appendChild(n),s.appendChild(a),s}},o=function(e){this.atts=e,this.render=function(){return t("div",{id:"location-spinner","class":"spinner",style:"display: block;"},"<div></div><div></div><div></div>")}};return{Current:e,Period:n,Today:a,Day:s,Forecast:i,Location:r,LocationSpinner:o}}();!function(){var t=function(t,e,n,a){var s=new XMLHttpRequest;s.open(e,t,!0),s.onload=function(){this.status>=200&&this.status<400?n(this):a(this)},s.onerror=function(){a(this)},s.send()},e=function(t){for(var e=t.length,n=0;e>n;n++)if(!t[n])return!1;return!0},n=function(t){var e=18e5;return Date.now()-t>e},a=function(t,e){return t-=273.15,"imperial"==e&&(t=1.8*t+32),Math.round(t)},s=function(t,e){return"imperial"==e&&(t=.03937*t),t},i=function(t,e,n){var a=new components.Current(t),s=new components.Today({today:e}),i=new components.Forecast({days:n}),r=document.getElementById("main");r.innerHTML="",r.appendChild(a.render()),r.appendChild(document.createElement("hr")),r.appendChild(s.render()),r.appendChild(document.createElement("hr")),r.appendChild(i.render())},r=function(t){chrome.storage.sync.get("units",function(e){var n=e.units||"metric";console.log(t);var r,o,c=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d=["January","February","March","April","May","June","July","August","September","October","November","December"],l={img:"icons/"+t[0].weather[0].icon.substr(0,2)+".png",temp:a(t[0].main.temp,n),desc:t[0].weather[0].main},p=[];for(r=0;5>r;r++){o=new Date(1e3*t[1].list[r].dt);var u="0"+o.getHours();u=u.substr(u.length-2);var h="0"+o.getMinutes();h=h.substr(h.length-2);var m=0;t[1].list[r].rain?m=+t[1].list[r].rain["3h"]:t[1].list[r].snow&&(m=+t[1].list[r].snow["3h"]),m=s(m,n).toFixed(2),length_unit="imperial"==n?"in":"mm",p.push({img:"icons/"+t[1].list[r].weather[0].icon.substr(0,2)+".png",temp:a(t[1].list[r].main.temp,n),precip:m,length_unit:length_unit,time:u+":"+h})}var g=[];for(r=0;5>r;r++)o=new Date(1e3*t[2].list[r].dt),g.push({img:"icons/"+t[2].list[r].weather[0].icon.substr(0,2)+".png",temp:a(t[2].list[r].temp.max,n),desc:t[2].list[r].weather[0].main,weekday:c[o.getDay()],month:d[o.getMonth()]+" "+o.getDate()});i(l,p,g)})},o=function(a,s,i,o){chrome.storage.local.get(a,function(c){if(c[a]&&!n(JSON.parse(c[a]).setAt))console.log("cache"),i[o]=JSON.parse(c[a]),e(i)&&r(i);else{var d=document.getElementById("spinner");d.style.display="block",t(s,"GET",function(t){console.log("ajaxed");var n=JSON.parse(t.response);i[o]=n;var s={};n.setAt=Date.now(),s[a]=JSON.stringify(n),chrome.storage.local.set(s),e(i)&&(r(i),d.style.display="none")},function(){console.log("error")})}})},c=function(){chrome.storage.sync.get("loc",function(t){t=t.loc&&JSON.parse(t.loc);var e={id:t&&t.id||6176823,name:t&&t.name||"waterloo"},n=[null,null,null];o("currentWeatherData","http://api.openweathermap.org/data/2.5/weather?id="+e.id,n,0),o("todayWeatherData","http://api.openweathermap.org/data/2.5/forecast?id="+e.id,n,1),o("forecastWeatherData","http://api.openweathermap.org/data/2.5/forecast/daily?id="+e.id,n,2),document.getElementById("location").innerText=e.name.substr(0,1).toUpperCase()+e.name.substr(1)}),chrome.storage.sync.get("units",function(t){for(var e=t.units||"metric",n=document.getElementsByClassName("units-btn"),a=n.length,s=0;a>s;s++)n[s].dataset.units==e?n[s].setAttribute("class","units-btn active"):n[s].setAttribute("class","units-btn")})};c();var d=function(){var t=document.getElementById("sidebar");t.style.display="block"===t.style.display?"none":"block"},l=function(){chrome.storage.local.clear(),c()},p=function(t){var e=t.target.dataset.name,n=t.target.dataset.id;chrome.storage.sync.set({loc:JSON.stringify({name:e,id:n})},function(){l(),d();var t=document.getElementById("locations");t.innerHTML="",document.getElementById("location-input").value=""})},u=function(){var e=document.getElementById("locations");e.innerHTML="",e.appendChild((new components.LocationSpinner).render());var n=document.getElementById("location-input").value;t("http://api.openweathermap.org/data/2.5/find?&q="+n+"&type=like&sort=population","GET",function(t){chrome.storage.sync.get("units",function(n){var s=n.units||"metric",i=JSON.parse(t.response);e.innerHTML="";var r=new components.Location;i.list.map(function(t){var n=t.name+","+t.sys.country,i=t.id,o=a(t.main.temp,s);r.attrs={name:n,id:i,temp:o};var c=r.render();c.onclick=p,e.appendChild(c)})})})};document.getElementById("menu-icon").onclick=d,document.getElementById("refresh").onclick=l,document.getElementById("search").onclick=u,document.getElementById("location-input").onkeypress=function(t){13==t.keyCode&&u(t)};var h=document.getElementsByClassName("units-btn");Array.prototype.forEach.call(h,function(t,e,n){t.onclick=function(){chrome.storage.sync.set({units:this.dataset.units});for(var t=n.length,a=0;t>a;a++)n[a].setAttribute("class","units-btn");n[e].setAttribute("class","units-btn active"),l()}})}();